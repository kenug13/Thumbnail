<!DOCTYPE html>
<html lang="id" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CuanBarengKenug - AI Image Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        darkbg: '#0f172a',
                        cardbg: '#1e293b'
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --primary-color: #6366f1;
        }

        body {
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6366f1;
        }

        .gradient-text {
            background: linear-gradient(90deg, #a78bfa, #f472b6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .main-bg {
            background: linear-gradient(135deg, #1e1b4b 0%, #111827 50%, #312e81 100%);
            min-height: 100vh;
        }

        .image-card .overlay {
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.9), transparent);
        }

        .image-card:hover .overlay {
            opacity: 1;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in { animation: fadeIn 0.6s ease-out forwards; }
        .image-card { animation: fadeIn 0.5s ease-out forwards; opacity: 0; }
        .image-card:nth-child(1) { animation-delay: 0.1s; }
        .image-card:nth-child(2) { animation-delay: 0.2s; }
        .image-card:nth-child(3) { animation-delay: 0.3s; }
        .image-card:nth-child(4) { animation-delay: 0.4s; }

        .input-focus-ring:focus-within {
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.4);
            border-color: var(--primary-color);
        }

        /* Toast Notification */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            background: rgba(31, 41, 55, 0.95);
            backdrop-filter: blur(5px);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            border-left: 4px solid #6366f1;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            font-size: 0.9rem;
            transform: translateX(100%);
            transition: transform 0.3s ease-out;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .toast.show {
            transform: translateX(0);
        }
    </style>
</head>

<body class="main-bg text-gray-100 p-4 sm:p-6 md:p-8 font-sans">

    <!-- Header Controls -->
    <div class="fixed top-5 right-5 z-50 flex gap-3">
        <button id="api-settings-btn" class="p-2 rounded-full bg-gray-800/50 text-white backdrop-blur-sm hover:bg-gray-700/50 transition-colors border border-gray-600" title="Set API Key">
            <i data-feather="settings" class="w-5 h-5"></i>
        </button>
        <button id="theme-toggle" class="p-2 rounded-full bg-gray-800/50 text-white backdrop-blur-sm hover:bg-gray-700/50 transition-colors border border-gray-600">
            <i data-feather="sun" class="hidden dark:block w-5 h-5"></i>
            <i data-feather="moon" class="block dark:hidden w-5 h-5"></i>
        </button>
    </div>

    <!-- Main Container -->
    <div class="container max-w-6xl mx-auto bg-gray-900/80 backdrop-blur-md p-6 sm:p-10 rounded-3xl shadow-2xl border border-gray-700 fade-in">
        <h1 class="text-3xl sm:text-5xl md:text-6xl font-extrabold text-center mb-2 gradient-text tracking-tight">CuanBarengKenug</h1>
        <p class="text-center text-sm sm:text-lg text-gray-400 mb-8 sm:mb-12">Wujudkan Imajinasimu dengan Kekuatan AI</p>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-10">
            
            <!-- Left Column: Inputs -->
            <div class="lg:col-span-7 space-y-6">
                
                <!-- Image Upload -->
                <div class="bg-gray-800/50 p-4 rounded-xl border border-gray-700 input-focus-ring transition-all">
                    <label class="text-sm font-semibold text-gray-300 flex items-center mb-2"><i data-feather="image" class="w-4 h-4 mr-2 text-indigo-400"></i>Upload Referensi (Opsional)</label>
                    <input type="file" id="imageUpload" accept="image/*" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-600 file:text-white hover:file:bg-indigo-500 cursor-pointer">
                    <div id="uploadedImageContainer" class="relative mt-4 hidden">
                        <img id="uploadedImagePreview" src="#" alt="Pratinjau" class="rounded-lg max-h-48 w-full object-contain bg-black/40 p-2">
                        <button id="clearImageBtn" class="absolute top-2 right-2 bg-red-500 hover:bg-red-600 text-white rounded-full p-1 shadow-md transition-colors"><i data-feather="x" class="w-4 h-4"></i></button>
                    </div>
                </div>

                <!-- Main Prompt -->
                <div class="bg-gray-800/50 p-4 rounded-xl border border-gray-700 input-focus-ring transition-all">
                    <label for="promptInput" class="text-sm font-semibold text-gray-300 flex items-center mb-2"><i data-feather="edit-3" class="w-4 h-4 mr-2 text-indigo-400"></i>Prompt Utama</label>
                    <textarea id="promptInput" rows="4" maxlength="3000" placeholder="Deskripsikan imajinasimu di sini... (Contoh: seekor kucing cyberpunk di kota neon)" class="w-full bg-gray-700/50 text-white p-3 rounded-lg border border-gray-600 focus:outline-none focus:border-indigo-500 transition-colors resize-none"></textarea>
                    <div class="flex flex-wrap gap-3 mt-3">
                        <button id="enhancePromptBtn" class="px-3 py-1.5 text-xs font-medium bg-violet-600/20 text-violet-300 rounded-lg hover:bg-violet-600/30 transition-colors border border-violet-500/30 flex items-center gap-1">‚ú® Tingkatkan Prompt</button>
                        <button id="ideaBtn" class="px-3 py-1.5 text-xs font-medium bg-amber-600/20 text-amber-300 rounded-lg hover:bg-amber-600/30 transition-colors border border-amber-500/30 flex items-center gap-1">üí° Ide Random</button>
                    </div>
                </div>

                <!-- Negative Prompt -->
                <div class="bg-gray-800/50 p-4 rounded-xl border border-gray-700 input-focus-ring transition-all">
                    <label for="negativePromptInput" class="text-sm font-semibold text-gray-300 flex items-center mb-2"><i data-feather="minus-circle" class="w-4 h-4 mr-2 text-indigo-400"></i>Prompt Negatif (Dihindari)</label>
                    <input type="text" id="negativePromptInput" placeholder="Contoh: buram, terpotong, jelek, teks, watermark" class="w-full bg-gray-700/50 text-white p-3 rounded-lg border border-gray-600 focus:outline-none focus:border-indigo-500 transition-colors">
                </div>
            </div>

            <!-- Right Column: Settings & Action -->
            <div class="lg:col-span-5 space-y-6 flex flex-col justify-between">
                <div class="bg-gray-800/50 p-6 rounded-xl border border-gray-700 space-y-6">
                    <div>
                        <label class="text-sm font-semibold text-gray-300 flex items-center mb-3"><i data-feather="crop" class="w-4 h-4 mr-2 text-indigo-400"></i>Rasio Aspek</label>
                        <div class="grid grid-cols-2 gap-3">
                            <button class="ratio-btn p-3 rounded-lg border border-gray-600 hover:border-indigo-500 hover:bg-gray-700 transition-all text-sm text-center active-ratio bg-gray-700 border-indigo-500" data-value="1:1">1:1 (Persegi)</button>
                            <button class="ratio-btn p-3 rounded-lg border border-gray-600 hover:border-indigo-500 hover:bg-gray-700 transition-all text-sm text-center" data-value="16:9">16:9 (Landscape)</button>
                            <button class="ratio-btn p-3 rounded-lg border border-gray-600 hover:border-indigo-500 hover:bg-gray-700 transition-all text-sm text-center" data-value="9:16">9:16 (Potret)</button>
                            <button class="ratio-btn p-3 rounded-lg border border-gray-600 hover:border-indigo-500 hover:bg-gray-700 transition-all text-sm text-center" data-value="4:3">4:3 (Klasik)</button>
                        </div>
                        <input type="hidden" id="aspectRatio" value="1:1">
                    </div>
                    
                    <div class="p-4 bg-indigo-900/20 rounded-lg border border-indigo-500/30">
                        <p class="text-xs text-indigo-200 text-center flex flex-col gap-1">
                            <span>‚ö° Powered by Google Gemini 2.5 & Imagen 4</span>
                            <span id="api-status-text" class="text-yellow-400 font-semibold cursor-pointer hover:underline">‚ö†Ô∏è API Key belum diatur</span>
                        </p>
                    </div>
                </div>

                <button id="generateBtn" class="w-full py-5 px-6 rounded-xl text-lg font-bold text-white bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-500 hover:to-violet-500 shadow-lg shadow-indigo-500/30 transform hover:-translate-y-1 transition-all duration-300 flex items-center justify-center gap-2 group disabled:opacity-50 disabled:cursor-not-allowed">
                    <i data-feather="zap" class="w-6 h-6 group-hover:text-yellow-300 transition-colors"></i>
                    <span>Generate Gambar</span>
                </button>
            </div>
        </div>

        <hr class="my-10 border-gray-700">

        <!-- Results Section -->
        <div>
            <h2 class="text-2xl font-bold text-center mb-8 flex items-center justify-center gap-2"><i data-feather="image" class="w-6 h-6 text-pink-500"></i> Hasil Karya</h2>
            
            <div id="loadingSpinner" class="hidden text-center py-12">
                <div class="w-16 h-16 border-4 border-gray-600 border-t-indigo-500 rounded-full animate-spin mx-auto"></div>
                <p class="mt-4 text-indigo-300 animate-pulse">Sedang meracik piksel...</p>
            </div>

            <div id="imageResults" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Images will appear here -->
            </div>
        </div>
    </div>

    <!-- Analysis Modal -->
    <div id="analysis-modal-backdrop" class="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4 hidden opacity-0 transition-opacity duration-300 backdrop-blur-sm">
        <div id="analysis-modal-content" class="bg-gray-800 text-white rounded-2xl shadow-2xl w-full max-w-2xl border border-gray-700 transform scale-95 opacity-0 transition-all duration-300 max-h-[85vh] flex flex-col">
            <div class="flex justify-between items-center p-6 border-b border-gray-700">
                <h3 class="text-xl font-bold flex items-center text-indigo-400"><i data-feather="eye" class="w-5 h-5 mr-2"></i>Analisis AI</h3>
                <button id="close-modal-btn" class="text-gray-400 hover:text-white transition-colors"><i data-feather="x" class="w-6 h-6"></i></button>
            </div>
            <div id="analysis-result" class="p-6 overflow-y-auto custom-scrollbar space-y-4 text-gray-300 leading-relaxed">
            </div>
        </div>
    </div>

    <!-- API Key Modal -->
    <div id="api-modal-backdrop" class="fixed inset-0 bg-black/90 z-[70] flex items-center justify-center p-4 hidden">
        <div class="bg-gray-800 text-white rounded-xl shadow-2xl w-full max-w-md border border-gray-600 p-6 transform scale-100 transition-all">
            <h3 class="text-xl font-bold mb-4 text-white">Pengaturan API Key</h3>
            <p class="text-sm text-gray-400 mb-4">Masukkan Google AI Studio API Key Anda. Key ini disimpan di browser Anda (LocalStorage) dan tidak dikirim ke server kami.</p>
            <input type="password" id="userApiKeyInput" placeholder="Paste API Key di sini (AIza...)" class="w-full bg-gray-900 text-white p-3 rounded-lg border border-gray-600 focus:outline-none focus:border-indigo-500 mb-4">
            <div class="flex justify-end gap-3">
                <button id="close-api-btn" class="px-4 py-2 text-gray-300 hover:text-white">Batal</button>
                <button id="save-api-btn" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg">Simpan</button>
            </div>
            <p class="text-xs text-gray-500 mt-4">Belum punya key? <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-indigo-400 hover:underline">Dapatkan di sini</a></p>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <footer class="text-center mt-12 mb-6 text-gray-500 text-xs">
        <p>&copy; 2025 CuanBarengKenug AI. All rights reserved.</p>
    </footer>

    <script>
        // --- KONFIGURASI API ---
        let GOOGLE_API_KEY = localStorage.getItem("cuan_gemini_key") || ""; 
        
        // Inisialisasi Icons
        feather.replace();

        // Elemen DOM
        const els = {
            imageUpload: document.getElementById('imageUpload'),
            uploadedContainer: document.getElementById('uploadedImageContainer'),
            uploadedPreview: document.getElementById('uploadedImagePreview'),
            clearImageBtn: document.getElementById('clearImageBtn'),
            aspectRatioInput: document.getElementById('aspectRatio'),
            ratioBtns: document.querySelectorAll('.ratio-btn'),
            promptInput: document.getElementById('promptInput'),
            negativeInput: document.getElementById('negativePromptInput'),
            generateBtn: document.getElementById('generateBtn'),
            resultsDiv: document.getElementById('imageResults'),
            spinner: document.getElementById('loadingSpinner'),
            enhanceBtn: document.getElementById('enhancePromptBtn'),
            ideaBtn: document.getElementById('ideaBtn'),
            themeToggle: document.getElementById('theme-toggle'),
            modalBackdrop: document.getElementById('analysis-modal-backdrop'),
            modalContent: document.getElementById('analysis-modal-content'),
            modalResult: document.getElementById('analysis-result'),
            closeModal: document.getElementById('close-modal-btn'),
            // API UI Elements
            apiSettingsBtn: document.getElementById('api-settings-btn'),
            apiModal: document.getElementById('api-modal-backdrop'),
            apiInput: document.getElementById('userApiKeyInput'),
            saveApiBtn: document.getElementById('save-api-btn'),
            closeApiBtn: document.getElementById('close-api-btn'),
            apiStatusText: document.getElementById('api-status-text')
        };

        let uploadedImageBase64 = null;

        // --- Toast Notification System ---
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            
            let icon = 'info';
            let color = '#6366f1'; // info color
            
            if (type === 'error') {
                icon = 'alert-circle';
                color = '#ef4444';
                toast.style.borderLeftColor = color;
            } else if (type === 'success') {
                icon = 'check-circle';
                color = '#22c55e';
                toast.style.borderLeftColor = color;
            }

            toast.innerHTML = `<i data-feather="${icon}" style="color:${color}"></i> <span>${message}</span>`;
            container.appendChild(toast);
            feather.replace();

            // Trigger animation
            requestAnimationFrame(() => {
                toast.classList.add('show');
            });

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // --- API Key Management ---
        function updateApiStatus() {
            if (GOOGLE_API_KEY && GOOGLE_API_KEY.length > 10) {
                els.apiStatusText.textContent = "‚úÖ API Key Tersimpan";
                els.apiStatusText.className = "text-green-400 font-semibold cursor-pointer hover:underline";
            } else {
                els.apiStatusText.textContent = "‚ö†Ô∏è API Key belum diatur";
                els.apiStatusText.className = "text-yellow-400 font-semibold cursor-pointer hover:underline";
            }
        }
        
        updateApiStatus();

        els.apiSettingsBtn.addEventListener('click', () => {
            els.apiInput.value = GOOGLE_API_KEY;
            els.apiModal.classList.remove('hidden');
        });

        els.apiStatusText.addEventListener('click', () => {
            els.apiInput.value = GOOGLE_API_KEY;
            els.apiModal.classList.remove('hidden');
        });

        els.closeApiBtn.addEventListener('click', () => {
            els.apiModal.classList.add('hidden');
        });

        els.saveApiBtn.addEventListener('click', () => {
            const key = els.apiInput.value.trim();
            if (key) {
                localStorage.setItem("cuan_gemini_key", key);
                GOOGLE_API_KEY = key;
                updateApiStatus();
                showToast("API Key berhasil disimpan!", "success");
                els.apiModal.classList.add('hidden');
            } else {
                showToast("API Key tidak boleh kosong", "error");
            }
        });


        // --- Helper Functions ---
        
        // Handle Aspect Ratio Selection
        els.ratioBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                els.ratioBtns.forEach(b => {
                    b.classList.remove('bg-gray-700', 'border-indigo-500', 'active-ratio');
                    b.classList.add('border-gray-600');
                });
                btn.classList.add('bg-gray-700', 'border-indigo-500', 'active-ratio');
                btn.classList.remove('border-gray-600');
                els.aspectRatioInput.value = btn.dataset.value;
            });
        });

        // Theme Toggle
        els.themeToggle.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            feather.replace();
        });

        // Image Handling
        els.imageUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                // Limit size 4MB
                if(file.size > 4 * 1024 * 1024) {
                    showToast("Ukuran gambar maksimal 4MB", "error");
                    return;
                }

                const reader = new FileReader();
                reader.onload = (ev) => {
                    els.uploadedPreview.src = ev.target.result;
                    els.uploadedContainer.classList.remove('hidden');
                    uploadedImageBase64 = ev.target.result.split(',')[1];
                };
                reader.readAsDataURL(file);
            }
        });

        els.clearImageBtn.addEventListener('click', () => {
            els.imageUpload.value = '';
            els.uploadedContainer.classList.add('hidden');
            uploadedImageBase64 = null;
        });

        // --- API Functions ---

        async function callGeminiText(prompt, imageBase64 = null) {
            if (!GOOGLE_API_KEY) throw new Error("API Key belum diisi! Klik icon gear/settings di pojok kanan atas.");
            
            const model = "gemini-2.5-flash-preview-09-2025"; // Update ke Gemini 2.5 Flash
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${GOOGLE_API_KEY}`;
            
            const parts = [{ text: prompt }];
            if (imageBase64) {
                parts.push({ inlineData: { mimeType: "image/png", data: imageBase64 }});
            }

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts }] })
            });

            if (!response.ok) {
                const errData = await response.json();
                throw new Error(errData.error?.message || "Gagal menghubungi Gemini.");
            }

            const result = await response.json();
            return result.candidates[0].content.parts[0].text.trim();
        }

        async function generateImageAPI(prompt, ratio) {
            if (!GOOGLE_API_KEY) throw new Error("API Key belum diisi!");

            // Menggunakan endpoint predict untuk Imagen 4
            const model = "imagen-4.0-generate-001"; 
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:predict?key=${GOOGLE_API_KEY}`;
            
            const payload = {
                instances: [{ prompt: prompt }],
                parameters: { 
                    sampleCount: 4, 
                    aspectRatio: ratio 
                }
            };

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errText = await response.text();
                if(response.status === 404 || response.status === 403) {
                    throw new Error("Akses ke Imagen ditolak. Pastikan API Key valid dan project Google Cloud Anda memiliki akses ke Imagen 4.");
                }
                throw new Error(`Error ${response.status}: ${errText}`);
            }

            return await response.json();
        }

        // --- Event Listeners Action ---

        // Enhance Prompt
        els.enhanceBtn.addEventListener('click', async () => {
            const current = els.promptInput.value;
            if(!current) return showToast("Isi prompt dulu!", "error");
            
            els.enhanceBtn.disabled = true;
            els.enhanceBtn.textContent = "Sedang berpikir...";
            
            try {
                const prompt = `Rewrite this image prompt to be highly detailed, artistic, and cinematic suitable for an AI image generator. Only output the prompt text, nothing else: "${current}"`;
                const enhanced = await callGeminiText(prompt);
                els.promptInput.value = enhanced;
                showToast("Prompt berhasil ditingkatkan!", "success");
            } catch (e) {
                showToast(e.message, "error");
            } finally {
                els.enhanceBtn.disabled = false;
                els.enhanceBtn.innerHTML = "‚ú® Tingkatkan Prompt";
            }
        });

        // Random Idea
        els.ideaBtn.addEventListener('click', async () => {
            els.ideaBtn.disabled = true;
            els.ideaBtn.textContent = "...";
            try {
                const prompt = "Create a creative, random, highly detailed image prompt for AI generation. Just the prompt.";
                const idea = await callGeminiText(prompt);
                els.promptInput.value = idea;
            } catch (e) {
                showToast(e.message, "error");
            } finally {
                els.ideaBtn.disabled = false;
                els.ideaBtn.innerHTML = "üí° Ide Random";
            }
        });

        // Generate Image Flow
        els.generateBtn.addEventListener('click', async () => {
            const userPrompt = els.promptInput.value.trim();
            if (!userPrompt && !uploadedImageBase64) return showToast("Masukkan prompt atau upload gambar!", "error");
            
            // Check API Key first
            if(!GOOGLE_API_KEY) {
                els.apiModal.classList.remove('hidden');
                return showToast("Masukkan API Key terlebih dahulu", "error");
            }

            // UI State Loading
            els.generateBtn.disabled = true;
            els.generateBtn.innerHTML = `<i data-feather="loader" class="animate-spin w-5 h-5 mr-2"></i> Generating...`;
            feather.replace();
            els.resultsDiv.innerHTML = '';
            els.spinner.classList.remove('hidden');

            try {
                let finalPrompt = userPrompt;

                // Jika ada gambar upload, minta Gemini mendeskripsikannya dulu untuk dijadikan prompt
                if (uploadedImageBase64) {
                    showToast("Menganalisis gambar referensi...", "info");
                    const descPrompt = "Describe this image in extreme detail to be used as a prompt for image regeneration. Focus on style, lighting, and composition.";
                    const imgDesc = await callGeminiText(descPrompt, uploadedImageBase64);
                    finalPrompt = `${userPrompt}. Based on reference: ${imgDesc}`;
                }

                // Tambah style modifiers
                finalPrompt += " . 8k resolution, cinematic lighting, masterpiece, hyperrealistic.";
                if(els.negativeInput.value) {
                    finalPrompt += ` Exclude: ${els.negativeInput.value}`;
                }

                console.log("Sending Prompt:", finalPrompt);
                showToast("Mengirim request ke Imagen...", "info");

                // Panggil API Imagen
                const result = await generateImageAPI(finalPrompt, els.aspectRatioInput.value);

                // Render Hasil
                if (result.predictions) {
                    const [w, h] = els.aspectRatioInput.value.split(':');
                    
                    result.predictions.forEach((pred, index) => {
                        const b64 = pred.bytesBase64Encoded;
                        const src = `data:image/png;base64,${b64}`;
                        const fileName = `cuan_ai_${Date.now()}_${index}.png`;

                        const card = document.createElement('div');
                        card.className = 'image-card group relative w-full rounded-xl overflow-hidden shadow-xl bg-gray-800 border border-gray-700';
                        card.style.aspectRatio = `${w}/${h}`;
                        
                        // Fix for download functionality in iframe/sandbox: using document.createElement for cleaner approach
                        card.innerHTML = `
                            <img src="${src}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500">
                            <div class="overlay absolute inset-0 flex flex-col justify-end p-4">
                                <div class="flex justify-end gap-2">
                                    <button onclick="analyzeImage('${finalPrompt.replace(/'/g, "\\'")}', '${b64}')" class="p-2 bg-white/20 backdrop-blur-md hover:bg-white/40 rounded-full text-white transition-all" title="Analisis"><i data-feather="eye" class="w-4 h-4"></i></button>
                                    <a href="${src}" download="${fileName}" class="p-2 bg-white/20 backdrop-blur-md hover:bg-white/40 rounded-full text-white transition-all" title="Download"><i data-feather="download" class="w-4 h-4"></i></a>
                                </div>
                            </div>
                        `;
                        els.resultsDiv.appendChild(card);
                    });
                    feather.replace();
                    showToast("Gambar berhasil dibuat!", "success");
                }

            } catch (error) {
                console.error(error);
                els.resultsDiv.innerHTML = `
                    <div class="col-span-full bg-red-900/50 border border-red-500/50 p-6 rounded-xl text-center">
                        <p class="text-red-200 font-bold mb-2">Gagal Menghasilkan Gambar</p>
                        <p class="text-sm text-red-300">${error.message}</p>
                        <p class="text-xs text-gray-400 mt-4">Tips: Pastikan API Key valid dan mendukung model Imagen.</p>
                    </div>
                `;
                showToast("Terjadi kesalahan", "error");
            } finally {
                els.spinner.classList.add('hidden');
                els.generateBtn.disabled = false;
                els.generateBtn.innerHTML = `<i data-feather="zap" class="w-6 h-6 mr-2 group-hover:text-yellow-300"></i> Generate Gambar`;
                feather.replace();
            }
        });

        // Fungsi Analisis (Global scope)
        window.analyzeImage = async (promptSource, b64) => {
            if(!GOOGLE_API_KEY) {
                showToast("API Key diperlukan untuk analisis", "error");
                return;
            }

            els.modalBackdrop.classList.remove('hidden');
            // Animasi masuk
            setTimeout(() => {
                els.modalBackdrop.classList.remove('opacity-0');
                els.modalContent.classList.remove('opacity-0', 'scale-95');
            }, 10);

            els.modalResult.innerHTML = '<div class="text-center animate-pulse pt-10 pb-10">Sedang menganalisis komposisi dengan Gemini Vision...</div>';

            try {
                const analysisPrompt = `Act as an art critic. Analyze this image generated from prompt: "${promptSource}". 
                1. Give a short critique of the style.
                2. Suggest 3 better prompts to improve it.
                Format output in simple HTML (use <h4 class="text-lg font-bold text-indigo-300 mb-2"> for titles, <ul class="list-disc pl-5 mb-4"> for lists).`;
                
                const html = await callGeminiText(analysisPrompt, b64);
                els.modalResult.innerHTML = html;
            } catch (e) {
                els.modalResult.innerHTML = `<p class="text-red-400">Gagal analisis: ${e.message}</p>`;
            }
        };

        // Tutup Modal
        const hideModal = () => {
            els.modalBackdrop.classList.add('opacity-0');
            els.modalContent.classList.add('opacity-0', 'scale-95');
            setTimeout(() => els.modalBackdrop.classList.add('hidden'), 300);
        };

        els.closeModal.addEventListener('click', hideModal);
        els.modalBackdrop.addEventListener('click', (e) => {
            if(e.target === els.modalBackdrop) hideModal();
        });

    </script>
</body>
</html>
